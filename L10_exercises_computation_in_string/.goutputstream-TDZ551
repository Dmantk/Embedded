#include <stdio.h>

char arr[] = "15*6-2*{(2+10/2-1)+5*[(4-2*3)-(5*2+1)]}";

int calculation(char cSign, int iNum1, int iNum2){
    int result = 0;
    if(cSign == '+')    result = iNum1 + iNum2;
    if(cSign == '-')    result = iNum1 - iNum2;
    if(cSign == '*')    result = iNum1 * iNum2;
    if(cSign == '/')    result = iNum1 / iNum2;
    return result;
}

void simplifyExpression(int* arrNumber, char* arrSign,int iIndexSign, int start, int end){
    printf("Xu ly dau */ tu %d den %d\n",start,end);
    for(int i = start; i < end; i++){
        if(arrSign[i] == '*' || arrSign[i] == '/'){
            arrNumber[i] = calculation(arrSign[i], arrNumber[i], arrNumber[i+1]);
            arrSign[i] = arrSign[i+1];
            //printf("'%d' So: %d\n", i, arrNumber[i]);
            //printf("'%d' Dau: %c\n", i, arrSign[i]);
            end--;
            for(int j = i+1; j < iIndexSign; j++){
                arrNumber[j] = arrNumber[j+1];
                arrSign[j] = arrSign[j+1];
            }
        }
    }
    for(int j =0;arrSign[j-1]!='f';j++){
		printf("[%d] So: %d\n", j, arrNumber[j]);
        printf("[%d] Dau: %c\n", j, arrSign[j]);
	}
    printf("Xu ly dau +- tu %d den %d\n",start,end);
    for(int i = start; i < end; i++){
        if(arrSign[start] == '+' || arrSign[start] == '-'){
            arrNumber[start] = calculation(arrSign[start], arrNumber[start], arrNumber[start+1]);
            arrSign[start] = arrSign[start+1];
            printf("'%d' So: %d\n", i, arrNumber[i]);
            printf("'%d' Dau: %c\n", i, arrSign[i]);
            for(int j = start+1; j < iIndexSign; j++){
                arrNumber[j] = arrNumber[j+1];
                arrSign[j] = arrSign[j+1];
            }
        }
    }
    printf("Ket qua la: %d\n", arrNumber[start]);
    printf("Ket qua la: %c\n", arrSign[start]);
}


void process(char* arr, int (*calculation)(char, int, int)){
    int i = 0, flag = 0;
    int arrNumber[20];
    int iIndexNumber = -1;
    char arrSign[20];
    int iIndexSign = -1;
    char arrSpecialSign[20];
    int iIndexSpecialSign = -1;
    int arrSpecialPosition[20];
    
    while (arr[i] != '\0') {
        if (arr[i] == '-' && iIndexNumber == -1) {
            flag = 1;
        }
        if (arr[i] >= '0' && arr[i] <= '9') {
            int number = 0;
            while (arr[i] >= '0' && arr[i] <= '9') {
                number = number * 10 + (arr[i] - '0');
                i++;
            }
            iIndexNumber++;
            if(flag == 1){
                arrNumber[iIndexNumber] = -number;
            } else {
                arrNumber[iIndexNumber] = number;
            }
            flag = 0;
            printf("'%d' So: %d\n", iIndexNumber, arrNumber[iIndexNumber]);
        } else if ((arr[i] == '+' || arr[i] == '-' || arr[i] == '*' || arr[i] == '/') && iIndexNumber >= 0) {
            iIndexSign++;
            arrSign[iIndexSign] = arr[i];
            printf("'%d' Dau: %c\n", iIndexSign, arrSign[iIndexSign]);
            i++;
        } else if (arr[i] == '(' || arr[i] == ')' || arr[i] == '[' || arr[i] == ']'|| arr[i] == '{' || arr[i] == '}') { 
            iIndexSpecialSign++;
            arrSpecialSign[iIndexSpecialSign] = arr[i];
            printf("'%d' Dau ngoac: %c\n", iIndexSpecialSign, arrSpecialSign[iIndexSpecialSign]);
            arrSpecialPosition[iIndexSpecialSign] = iIndexSign+1;
            printf("'%d' Vi tri dau ngoac: %d\n", iIndexSpecialSign, arrSpecialPosition[iIndexSpecialSign]);
            i++;
        } else {
            i++;
        }
    }
    iIndexSpecialSign++;
    arrSpecialSign[iIndexSpecialSign] = 'f';
    iIndexSign++;
    arrSign[iIndexSign] = 'f';
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
	while(arrSpecialSign[0] != 'f'){
		for(i=0;i<iIndexSpecialSign;i++){
			if((arrSpecialSign[i]=='(' && arrSpecialSign[i+1]==')')||(arrSpecialSign[i]=='[' && arrSpecialSign[i+1]==']')||(arrSpecialSign[i]=='{' && arrSpecialSign[i+1]=='}')){
				for(int j = 0;arrSpecialSign[j-1] != 'f';j++){
					printf("%d:%c:%d\n",j,arrSpecialSign[j],arrSpecialPosition[j]);
				}
				
				printf("itruoc[%d] %c%c : %d-%d\n",i,arrSpecialSign[i],arrSpecialSign[i+1],arrSpecialPosition[i],arrSpecialPosition[i+1]);
				simplifyExpression(arrNumber, arrSign, iIndexSign, arrSpecialPosition[i], arrSpecialPosition[i+1]);
				int move = arrSpecialPosition[i+1]- arrSpecialPosition[i];
				printf("move: %d\n",move);
				for(int j = i;arrSpecialSign[j-1] != 'f';j++){
					arrSpecialSign[j] = arrSpecialSign[j+2];
					arrSpecialPosition[j] = arrSpecialPosition[j+2];
					arrSpecialPosition[j] -= move;
				}			
			}
		}
	}
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    simplifyExpression(arrNumber, arrSign,iIndexSign, 0, iIndexSign);
    printf("Ket qua phep tinh la: %d\n", arrNumber[0]);
}
int main() {    
    process(arr, &calculation);
    return 0;
}
